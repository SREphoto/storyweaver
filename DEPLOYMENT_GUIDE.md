# StoryWeaver Deployment Guide

## âœ… FIXES APPLIED (December 24, 2024)

### Problems Fixed

1. **User Persistence** - Users can now log in after registration (PostgreSQL database)
2. **API Reliability** - Better error handling and timeout management
3. **Database Performance** - Migrated from 54MB JSON file to PostgreSQL
4. **Memory Issues** - Optimized for Render free tier (512MB limit)

---

## ğŸš€ Deployment Steps

### 1. Prerequisites

- GitHub account
- Render account (free tier works)
- Gemini API key

### 2. Push Code to GitHub

```bash
git add .
git commit -m "feat: Add PostgreSQL support and fix persistence issues"
git push origin main
```

### 3. Deploy to Render

#### A. Connect Render to GitHub

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click "New +" â†’ "Blueprint"
3. Connect your GitHub repository
4. Select the `storyweaver` repository

#### B. Configure Environment Variables

Render will automatically create the database from `render.yaml`. You just need to add:

1. Go to your service â†’ "Environment"
2. Add `GEMINI_API_KEY`:

   ```
   Key: GEMINI_API_KEY
   Value: <your-gemini-api-key>
   ```

#### C. Deploy

1. Click "Apply" or "Manual Deploy"
2. Wait for deployment (~5-10 minutes)
3. Database will be created automatically

### 4. Deploy Frontend to GitHub Pages

```bash
npm run build
npm run deploy
```

---

## ğŸ”§ Configuration

### Environment Variables

#### Local Development (`.env.local`)

```
GEMINI_API_KEY=your_key_here
JWT_SECRET=your_secret_here
```

#### Production (Render)

- `GEMINI_API_KEY` - Set manually
- `JWT_SECRET` - Auto-generated by Render
- `DATABASE_URL` - Auto-injected from PostgreSQL database
- `NODE_ENV` - Set to `production`

---

## ğŸ—„ï¸ Database

### Development

Uses `data/db.json` file (auto-created)

### Production (Render)

Uses PostgreSQL database:

- Free tier: 256MB storage
- Auto-managed by Render
- Connection string auto-injected

### Database Schema

```sql
-- Users table
CREATE TABLE users (
    id VARCHAR(255) PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    passwordHash VARCHAR(255) NOT NULL
);

-- Stories table
CREATE TABLE stories (
    id VARCHAR(255) PRIMARY KEY,
    userId VARCHAR(255) NOT NULL,
    title TEXT NOT NULL,
    premise TEXT,
    lastUpdated TIMESTAMP NOT NULL,
    data JSONB,
    FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE
);
```

---

## ğŸ› Troubleshooting

### Issue: Users can't log in

**Solution**: Database was reset. This should no longer happen with PostgreSQL.

If it persists:

1. Check Render logs: Dashboard â†’ Service â†’ Logs
2. Verify `DATABASE_URL` is set
3. Check database status in Render Dashboard

### Issue: API calls timing out

**Solution**: The API has a 30-second timeout on Render free tier.

Workarounds:

1. Reduce AI generation complexity
2. Implement client-side retries (already added)
3. Upgrade to Render Starter plan ($7/month)

### Issue: Map/Character generation failing

**Previous cause**: Missing error handling
**Fix**: Added proper error handling and fallbacks

Check browser console (F12) for specific errors.

### Issue: Database is full

PostgreSQL free tier: 256MB limit

**Solutions**:

1. Delete old stories regularly
2. Store images externally (Cloudinary, S3)
3. Upgrade database plan

---

## ğŸ“Š Monitoring

### Check Backend Status

```
https://storyweaver-api.onrender.com/health
```

Should return: `{"status":"ok"}`

### Check Database Connection

From Render Dashboard:

1. Go to your PostgreSQL database
2. Click "Info" tab
3. Check connection count and status

### View Logs

```bash
# In Render Dashboard
Service â†’ Logs â†’ Live Logs
```

---

## ğŸ”„ Updates & Maintenance

### Update Code

```bash
git add .
git commit -m "your message"
git push origin main
```

Render auto-deploys on push (if auto-deploy is enabled).

### Manual Deploy

Render Dashboard â†’ Service â†’ Manual Deploy â†’ Deploy Latest Commit

### Database Backup

Render Dashboard â†’ Database â†’ Backups

Free tier: Manual backups only

---

## ğŸ’° Cost Breakdown

### Current Setup (FREE)

- Render Web Service: Free
- Render PostgreSQL: Free (256MB)
- GitHub Pages: Free
- **Total: $0/month**

### Recommended for Production

- Render Starter: $7/month (1GB RAM, persistent disk)
- Render PostgreSQL: $7/month (1GB storage)
- **Total: $14/month**

---

## ğŸ†˜ Support

If issues persist after deployment:

1. **Check Logs**: Render Dashboard â†’ Service â†’ Logs
2. **Verify Environment**: All variables set correctly?
3. **Database Status**: Is PostgreSQL running?
4. **Frontend Console**: Check browser console (F12) for errors

### Common Error Messages

**"Invalid credentials"** â†’ Database reset or user doesn't exist
**"Failed to fetch"** â†’ Backend down or CORS issue
**"Request timeout"** â†’ AI generation taking too long
**"Database connection error"** â†’ PostgreSQL not connected

---

## âœ¨ What's New

### Version 1.2.0 (December 24, 2024)

#### âœ… Added

- PostgreSQL database support
- Automatic database fallback (PostgreSQL â†’ JSON)
- Better error handling across all routes
- Request timeout handling
- Environment-based configuration

#### ğŸ”§ Fixed

- User persistence (no more re-registration needed!)
- API timeout issues
- Memory leaks from large JSON file
- Error messages not shown to users

#### ğŸ“¦ Dependencies

- Added `pg` for PostgreSQL support
- Added `@types/pg` for TypeScript

---

## ğŸ“ License

Private project - All rights reserved
